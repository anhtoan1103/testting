<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Rút thăm</title>
<style>
    body { font-family: Arial; max-width: 500px; margin: 40px auto; }
    button { padding: 10px 20px; margin-top: 10px; }
    #result { margin-top: 20px; font-size: 20px; font-weight: bold; }
    #nextLink { margin-top: 20px; word-wrap: break-word; }
</style>
</head>
<body>

<h2>Rút thăm</h2>

<p>Chọn tên của bạn:</p>
<select id="myName">
    <option value="">-- Chọn tên --</option>
</select>

<br><br>
<button onclick="start()">Rút</button>

<div id="result"></div>
<div id="nextLink"></div>

<script>
// ===========================
// CONFIG
// ===========================
const participants = ["An", "Binh", "Chi", "Dung"];
const SALT = "random_secret_salt_2025_change_me";

// Populate dropdown
const select = document.getElementById("myName");
participants.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
});

// ===========================
// HASH FUNCTION (SHA-256)
// ===========================
async function hashString(str) {
    const msgUint8 = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// ===========================
// PARSE HASH LIST FROM URL
// ===========================
function getUsedHashes() {
    const params = new URLSearchParams(window.location.search);
    const list = params.get("used");
    if (!list) return [];
    return list.split(",");
}

// ===========================
// MAIN DRAW FUNCTION
// ===========================
async function start() {
    const myName = document.getElementById("myName").value;

    if (!myName) {
        alert("Vui lòng chọn tên của bạn");
        return;
    }

    const usedHashes = getUsedHashes();

    // Identify names already drawn
    const usedNames = [];
    for (const name of participants) {
        const h = await hashString(SALT + name);
        if (usedHashes.includes(h)) {
            usedNames.push(name);
        }
    }

    // Valid pool (not self + not used)
    const pool = participants.filter(
        x => x !== myName && !usedNames.includes(x)
    );

    if (pool.length === 0) {
        document.getElementById("result").innerText =
            "Không còn tên nào hợp lệ để rút!";
        return;
    }

    // Random pick
    const picked = pool[Math.floor(Math.random() * pool.length)];

    // Hash picked name
    const pickedHash = await hashString(SALT + picked);

    // Build URL for next person
    const newList = [...usedHashes, pickedHash].join(",");
    const nextURL = `${window.location.origin}${window.location.pathname}?used=${newList}`;

    // Show results
    document.getElementById("result").innerHTML =
        `Bạn rút được: <b>${picked}</b>`;

    document.getElementById("nextLink").innerHTML =
        `Link để gửi cho người tiếp theo:<br><a href="${nextURL}">${nextURL}</a>`;
}
</script>

</body>
</html>
