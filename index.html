<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Rút thăm</title>
<style>
    body { font-family: Arial; max-width: 500px; margin: 40px auto; }
    button { padding: 10px 20px; margin-top: 10px; }
    #result { margin-top: 20px; font-size: 20px; font-weight: bold; }
    #nextLink { margin-top: 20px; word-wrap: break-word; }
</style>
</head>
<body>

<h2>Rút thăm</h2>

<p>Nhập tên của bạn:</p>
<input id="myName" placeholder="Ví dụ: An"><br><br>
<button onclick="start()">Rút</button>

<div id="result"></div>
<div id="nextLink"></div>

<script>
// ===========================
// CONFIG
// ===========================
const participants = ["An", "Binh", "Chi", "Dung"];
const SALT = "random_secret_salt_2025_change_me";

// ===========================
// HASH FUNCTION (SHA-256)
// ===========================
async function hashString(str) {
    const msgUint8 = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// ===========================
// PARSE HASH LIST FROM URL
// ===========================
function getUsedHashes() {
    const params = new URLSearchParams(window.location.search);
    const list = params.get("used");
    if (!list) return [];
    return list.split(",");
}

// ===========================
// MAIN
// ===========================
async function start() {
    const myName = document.getElementById("myName").value.trim();
    if (!participants.includes(myName)) {
        alert("Tên bạn không có trong danh sách!");
        return;
    }

    const usedHashes = getUsedHashes();

    // Lọc ra những người đã bị rút (dựa vào hash)
    const usedNames = [];
    for (const name of participants) {
        const h = await hashString(SALT + name);
        if (usedHashes.includes(h)) {
            usedNames.push(name);
        }
    }

    // Tạo pool hợp lệ
    const pool = participants.filter(
        x => x !== myName && !usedNames.includes(x)
    );

    if (pool.length === 0) {
        document.getElementById("result").innerText =
            "Không còn tên nào hợp lệ để rút!";
        return;
    }

    // Random pick
    const picked = pool[Math.floor(Math.random() * pool.length)];

    // Hash của người được rút
    const pickedHash = await hashString(SALT + picked);

    // Cập nhật URL cho người tiếp theo
    const newList = [...usedHashes, pickedHash].join(",");
    const nextURL = `${window.location.origin}
